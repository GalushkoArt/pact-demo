# Демонстрация контрактного тестирования с Pact

Этот проект демонстрирует контрактное тестирование на основе Pact в микросервисной архитектуре, фокусируясь на домене сервиса цен с REST API коммуникацией между сервисами поставщика и потребителя.

После прочтения README можно посмотреть [docs](docs)

## Обзор проекта

В современных микросервисных архитектурах обеспечение надежной коммуникации между сервисами имеет решающее значение. Этот демонстрационный проект показывает, как реализовать контрактное тестирование с использованием Pact, инструмента контрактного тестирования, управляемого потребителем, который помогает командам обнаруживать проблемы интеграции на ранних этапах цикла разработки.

## Предварительные требования

- Java 17 или выше
- Gradle 8.0 или выше
- Docker и Docker Compose (для запуска Pact Broker и PostgreSQL)

## Начало работы

### 1. Клонируем репозиторий

```bash
git clone https://github.com/GalushkoArt/pact-demo.git
cd pact-demo
```

### 2. Запускаем PostgreSQL и Pact Broker

```bash
# Используя Makefile
make docker-start

# Или напрямую с docker-compose
docker-compose up -d
```

Это запустит:
- PostgreSQL для приложения на порту 5432
- PostgreSQL для тестов на порту 5433
- Pact Broker на порту 9292

Pact Broker будет доступен по адресу http://localhost:9292 со следующими учетными данными:
- Имя пользователя: `pact`
- Пароль: `pact`

### 3. Структура проекта

Перед запуском тестов ознакомьтесь со структурой проекта:

- **price-service-provider**: Сервис, реализующий API (поставщик)
- **price-service-consumer**: Клиент, потребляющий API (потребитель)
- **new-price-service-consumer**: Еще один клиент, потребляющий API (потребитель)

Каждый модуль содержит:
- `src/main/java`: Код приложения
- `src/test/java`: Тестовый код, включая контрактные тесты Pact
- `build.gradle`: Зависимости и конфигурация Pact для конкретного модуля

### 4. Запуск полной демонстрации

Вы можете запустить полную демонстрацию рабочего процесса:

```bash
# Запуск полной демонстрации
make full-workflow
```

## Демонстрация рабочего процесса контрактного тестирования

Этот раздел демонстрирует полный рабочий процесс с использованием команд из Makefile. Следуйте этим шагам, чтобы понять, как работает контрактное тестирование с Pact на практике.

### 1. Запустить контейнеры

Сначала запустите контейнеры Docker для PostgreSQL и Pact Broker:

```bash
make docker-start
```

Эта команда запускает контейнеры в отсоединенном режиме и ждет, пока они будут готовы.

### 2. Запустить тесты потребителя и создать контракты

Запустите тесты для первого потребителя и опубликуйте сгенерированные контракты Pact в брокере:

```bash
make consumer-tests
```

Это:
- Запустит тесты для price-service-consumer
- Сгенерирует файлы контрактов Pact (расположенные в [price-service-consumer/build/pacts/](price-service-consumer/build/pacts/))
- Опубликует контракты в Pact Broker

### 3. Проверить Pact Broker

Откройте пользовательский интерфейс Pact Broker, чтобы увидеть опубликованные контракты:
[http://localhost:9292/](http://localhost:9292/)

Вы должны увидеть контракты между price-service-consumer и price-service-provider.

### 4. Проверить поставщика на соответствие контрактам

Запустите тесты проверки поставщика, чтобы убедиться, что поставщик может выполнить контракты:

```bash
make pact-tests
```

Эта команда запускает тесты JUnit5 в модуле price-service-provider, который проверяет поставщика на соответствие опубликованным контрактам Pact.

### 5. Проверить Pact Broker снова

Обновите пользовательский интерфейс Pact Broker, чтобы увидеть результаты проверки:
[http://localhost:9292/](http://localhost:9292/)

Теперь вы должны увидеть, что контракты были проверены.

### 6. Проверить совместимость деплоя

Проверьте, можно ли безопасно развернуть потребителя и поставщика:

```bash
make canideploy-price
make canideploy-orderbook
make canideploy-consumer
```

Эта команда проверяет, могут ли price-service-provider-price, price-service-provider-orderbook и price-service-consumer быть задеплоены без нарушения работы какого-либо договора.
Теперь должно быть сказано `Computer says yes \o/`.

### 7. Запустить тесты для нового потребителя

Запустите тесты для нового потребителя и опубликуйте его контракты:

```bash
make new-consumer-tests
```

Это:
- Запустит тесты для new-price-service-consumer
- Сгенерирует файлы контрактов Pact (расположенные в [new-price-service-consumer/build/pacts/](new-price-service-consumer/build/pacts/))
- Опубликует контракты в Pact Broker

### 8. Проверить совместимость развертывания Orderbook

Проверьте, можно ли безопасно развернуть поставщика orderbook:

```bash
make canideploy-orderbook
```

Это должно пройти с `Computer says yes \o/`, потому что новый потребитель не использует этого поставщика.

### 9. Проверить совместимость развертывания Price

Проверьте, можно ли безопасно развернуть поставщика price:

```bash
make canideploy-price
```

Это должно завершиться неудачей с `Can you deploy? Computer says no ¯\_(ツ)_/¯`, потому что новый потребитель использует этого поставщика, а поставщик еще не проверил новые контракты.

### 10. Запустить тесты поставщика снова

Запустите тесты поставщика снова:

```bash
make pact-tests
```

Это проверит все контракты, включая контракты от нового потребителя.

### 11. Проверить Pact Broker еще раз

Обновите пользовательский интерфейс Pact Broker еще раз, чтобы увидеть обновленные результаты проверки:
[http://localhost:9292/](http://localhost:9292/)

Теперь вы должны увидеть, что все контракты были проверены.

### 12. Проверить совместимость развертывания снова

Проверьте, можно ли теперь безопасно развернуть обоих поставщиков:

```bash
make canideploy-price
make canideploy-orderbook
make canideploy-new-consumer
```

Теперь это должно пройти с `Computer says yes \o/` для обоих поставщиков и нового потребителя.

## Дополнительные ресурсы

Можно ещё почитать [Официальную документацию пакта на английском](https://docs.pact.io/) или посмотреть переведённую документацию в проекте (от 2025.06.15)

Что посмотреть в [docs](docs):
- [Руководство по настройке CI/CD (aka Pact Nirvana)](docs/pact_nirvana_ru.md)
- [Убедите меня](docs/faq/convinceme_ru.md)
- [Версионирование в Pact Broker](docs/getting_started/versioning_in_the_pact_broker_ru.md)
- [Когда использовать Pact](docs/getting_started/what_is_pact_good_for_ru.md)

### Документация и руководства

- [Официальная документация Pact](https://docs.pact.io/)
- [Документация Pact JVM](https://github.com/pact-foundation/pact-jvm)
- [Руководство по интеграции Spring Boot и Pact](https://docs.pact.io/implementation_guides/jvm/provider/spring)
