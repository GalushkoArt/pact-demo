---
title: Обзор
---

**Pact Broker** — это сервис, поддерживающий контрактное тестирование путём организации обмена контрактами (pact'ами) и
результатами их верификации.

## Как система непрерывной интеграции взаимодействует с Pact Broker

* CI-сборка потребителя генерирует контракты во время изолированного тестирования и публикует их.
* CI-сборка поставщика загружает контракты, локально их верифицирует и публикует результаты обратно в брокер.
* Сборки для деплоя потребителя и поставщика обращаются к брокеру перед развёртыванием, чтобы убедиться, что версия
  приложения, которую они собираются развернуть, совместима с уже развернутыми версиями других приложений в этой среде.

## Контракты (Pacts)

Контракт публикуется с использованием имени потребителя, имени поставщика и версии _приложения-потребителя_ в качестве
идентификатора  
\(`PUT /pacts/provider/PROVIDER/consumer/CONSUMER/version/CONSUMER_APPLICATION_VERSION`\). Версионирование _содержимого
контракта_ осуществляется брокером автоматически и не требует ручного управления со стороны пользователя.

## Pacticipant'ы

`Consumer` и `provider` приложения называются `pacticipant` (игра слов, о которой автор Pact Broker теперь жалеет). Один
`pacticipant` может быть одновременно `consumer` и `provider`. Pacticipant'ы создаются автоматически при первой
публикации контракта.

## Версии pacticipant'ов

Pacticipant может иметь множество версий (т.е. версий приложения). Каждая версия
идентифицируется [номером версии](../pacticipant_version_numbers_ru), обычно это git SHA (или ревизия Subversion) или
семантический номер с указанием ссылки на репозиторий. Ресурс версии pacticipant создаётся автоматически при публикации
контракта или результата верификации, если он ещё не существует. Версия будет иметь связанный контракт, если она
является версией потребителя, и будет иметь результат верификации, если она является версией поставщика.

## Результаты верификации

Когда публикуется контракт, известны `provider`, `consumer` и версия `consumer`. Но версия `provider` становится
известна только после верификации и публикации результатов. Верификация публикуется с указанием имени потребителя, имени
поставщика и SHA _содержимого контракта_. Это означает, что если будет опубликован новый контракт с идентичным
содержанием, он автоматически унаследует существующие результаты верификации.

## Теги (Tags)

Теги используются для "закладок" важных версий приложения (в API — `pacticipant`). Обычно используются для обозначения
стадий (например, `dev`, `staging`, `prod`) или веток (например, `feat-some-new-thing`) вашего приложения.  
Например, можно назначить тег `prod` для версии `1.2.3+c6d6a4` приложения `Foo`  
\(`PUT /pacticipants/PACTICIPANT/versions/VERSION/tags/TAG`\).  
Версия может иметь несколько тегов, а один тег может быть присвоен многим версиям. Обычно интересует последняя версия с
определённым тегом, например, последняя `prod`.

Хотя теги относятся к _версиям pacticipant'ов_, на практике они часто используются для получения _контрактов_.  
Например, чтобы получить последний контракт `prod` или `feat-some-new-thing`  
\(`GET /pacts/provider/PROVIDER/consumer/CONSUMER/latest/TAG`\).

## Webhooks

Webhook'и — это настраиваемые HTTP-запросы, которые запускаются при наступлении определённых событий в Pact Broker.
Самые частые сценарии — запуск сборки поставщика при публикации нового контракта и запуск сборки потребителя при
публикации результатов верификации.

## Матрица (Matrix)

**Матрица** — это таблица, получаемая путём объединения всех публикаций контрактов и всех публикаций результатов
верификации. Она показывает, какие версии потребителей и поставщиков _совместимы_, а какие — нет.

| Потребитель | Версия потребителя | Поставщик | Версия поставщика | Успешно? |
|:------------|:-------------------|:----------|:------------------|:---------|
| Foo         | 1                  | Bar       | 3                 | true     |
| Foo         | 1                  | Bar       | 4                 | true     |
| Foo         | 2                  | Bar       | 4                 | false    |
| Foo         | 2                  | Bar       | 5                 | true     |

В таблице выше `Foo` опубликовал контракт версии 1, который успешно прошёл верификацию на `Bar` версии 3. Версия 4 также
успешно его верифицировала. Затем `Foo` опубликовал контракт версии 2, но `Bar` версии 4 не прошёл верификацию, потому
что `Foo` добавил новое взаимодействие без согласования (ай-ай-ай!). В версии 5 `Bar` внёс изменения, чтобы успешно
пройти верификацию.

## Можно ли деплоить?

CLI-инструмент [can-i-deploy](can_i_deploy_ru) использует Матрицу для определения, можно ли безопасно
выпустить ваше приложение. Он проверяет, совместима ли версия приложения, которую вы собираетесь развернуть, с уже
развернутыми версиями других приложений в той же среде. По сути, он убеждается в наличии строки в Матрице с совпадающими
версиями потребителя и поставщика и значением `success = true`.

## Навигация по API

API Pact Broker использует [HAL](http://stateless.co/hal_specification.html) (Hypertext Application Language) в качестве
реализации гипермедиа (то есть способа предоставления ссылок внутри ресурса для перехода к связанным ресурсам). Брокер
поставляется с встроенным HAL-браузером, позволяющим просматривать API прямо в браузере, используя HAL-ссылки каждого
ресурса. Вы можете начать с индексного ресурса и переходить к любому другому просто нажатием кнопки `GET` по нужной
связи. Программные клиенты Pact Broker также используют эти ссылки, а не формируют URL вручную, чтобы API мог
эволюционировать без поломки клиентов.

Спецификация HAL также предусматривает встроенный способ документирования связей. В HAL-браузере документацию можно
открыть, кликнув на значок книги рядом с соответствующей связью.
