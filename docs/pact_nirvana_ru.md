---
title: Руководство по настройке CI/CD
sidebar_label: Введение
---

_«Шаги к Пакт-Нирване»_

Это техническое руководство для разработчиков и тестировщиков, желающих использовать Pact для внедрения контрактного тестирования, ориентированного на потребителя, как части текущего CI/CD процесса.

К концу этого руководства вы будете понимать, как создать пайплайн релиза, позволяющий независимо развёртывать любое приложение с уверенностью, что оно будет корректно взаимодействовать с другими приложениями в среде — без необходимости выполнять набор end-to-end тестов.

Это руководство сосредоточено на сценарии, когда и потребитель, и поставщик развёртываются в среду, а не выпускаются конечным пользователям (например, как мобильное приложение). Этот другой сценарий будет рассмотрен отдельно в будущем.

### Как использовать этот документ

Каждая интеграция уникальна. У каждой организации своя история и культура, и у каждой команды — свои процессы разработки, тестирования и развёртывания. Эти различия влияют на выбор наилучшего рабочего процесса Pact.

Тем не менее существует множество общих шагов на пути к полноценной и эффективной настройке Pact (или _«Пакт-Нирване»_). Этот документ описывает эти шаги.

Вы можете выбрать и реализовать только те шаги, которые подходят вашей команде. Возможно, вы остановитесь на первых этапах и будете использовать Pact как дополнение к вашим интеграционным тестам; или полностью откажетесь от последних и достигнете «Пакт-Нирваны».

Это руководство не объясняет подробно, как писать и запускать тесты потребителя или проверки поставщика. Здесь мы рассматриваем стратегию высокого уровня по настройке и использованию Pact. Каждый из приведённых уровней приближает вас к полностью автоматизированному процессу проверки контрактов как части CI/CD без необходимости в интеграционной среде.

Так как Pact реализован на многих языках, здесь излагается теория шагов. Для синтаксиса конкретных задач обратитесь к документации для вашего языка. См. раздел [руководств по реализации](/implementation_guides/cli).

### Какие шаги ведут к Пакт-Нирване?

1. [Подготовка — ознакомьтесь с Pact](pact_nirvana/step_1_ru)
2. [Разговор: достигните согласия в команде](pact_nirvana/step_2_ru)
3. Бронза: вручную создайте и выполните один тест
4. Серебро: вручную интегрируйтесь с Pact Broker
5. Золото: интеграция с PR пайплайнами
6. Платина: добавьте `can-i-deploy` с тегами веток в PR пайплайны
7. Бриллиант: добавьте Pact в пайплайны развёртывания
8. Курс с отличием — в разработке...
   1. Добавление состояний провайдера
   2. Работа с Feature Flags

Ниже представлены диаграммы, соответствующие каждому уровню.

<details>
  <summary>Диаграмма: Бронзовый уровень</summary>

```plantuml
@startuml
left to right direction
actor "Тест потребителя" as CT
actor "Проверка провайдера (локально)" as PV

CT --> [Pact файл] : запись
[Pact файл] --> PV : чтение
@enduml
````

</details>

<details>
  <summary>Диаграмма: Серебряный уровень</summary>

```plantuml
@startuml
left to right direction
actor "Тест потребителя" as CT
database "Pact Broker" as PB
actor "Проверка провайдера (по URL)" as PV

CT --> PB : публикация
PB --> PV : получение контракта
@enduml
```

</details>

<details>
  <summary>Диаграмма: Золотой уровень</summary>

```plantuml
@startuml
participant Потребитель
participant Провайдер
database Broker

Потребитель -> Broker : публикация контракта с веткой [feat 123]
note left: PR пайплайн

Потребитель -> Broker : публикация контракта с веткой [main]
note left: Пайплайн main

Провайдер --> Broker : проверка против ветки main потребителя и развернутых версий
Провайдер --> Broker : публикация результатов с версией провайдера и веткой
@enduml
```

</details>

<details>
  <summary>Диаграмма: Бриллиантовый уровень</summary>

```plantuml
@startuml
participant Потребитель
database Broker
participant Проверяющий

note left of Потребитель: PR пайплайн
Потребитель ->> Broker : publish pact с веткой [feat abc]

alt контракт изменён, нет проверки
  Broker ->> Проверяющий : webhook запускает проверку pact версии 123 [feat abc]
  Потребитель -> Broker : can-i-deploy --to-environment dev
  Потребитель -> Потребитель : ожидание результатов...
  Проверяющий -> Проверяющий : извлечение провайдера из ветки main
  Проверяющий -> Broker : загрузка pact версии 123
  Проверяющий -> Проверяющий : проверка контракта

  alt проверка пройдена
    Broker -> Потребитель : Yes
  else проверка провалена
    Broker -> Потребитель : NO
  end
else контракт не изменён, проверка уже существует
  Потребитель -> Broker : can-i-deploy --to-environment dev

  alt проверка пройдена
    Broker -> Потребитель : Yes
  else проверка провалена
    Broker -> Потребитель : NO
  end
end
@enduml
```

</details>

<details>
  <summary>Диаграмма: Бриллиант + Release Branch</summary>

```plantuml
@startuml
participant Провайдер
database Broker

note left of Провайдер: PR пайплайн
Провайдер -> Broker : проверка pact'ов с mainBranch и deployedOrReleased
Провайдер -> Broker : публикация результатов с веткой [feat abc]
Провайдер -> Broker : can-i-deploy --to-environment [staging]

note left of Провайдер: Пайплайн main ветки
Провайдер -> Broker : проверка pact'ов с mainBranch и deployedOrReleased
Провайдер -> Broker : публикация результатов с веткой [main]
Провайдер -> Broker : can-i-deploy --to-environment [staging]
Провайдер -> Провайдер : деплой в [staging]
Провайдер -> Broker : record-deployment --environment [staging]

note left of Провайдер: Пайплайн release-ветки
Провайдер -> Broker : can-i-deploy --to-environment [preprod]
Провайдер -> Broker : can-i-deploy --to-environment [prod]
Провайдер -> Провайдер : создание release ветки
Провайдер -> Провайдер : деплой в [preprod]
Провайдер -> Провайдер : запуск тестов [preprod]
Провайдер -> Broker : can-i-deploy --to-environment [prod]
Провайдер -> Провайдер : деплой в [prod]
Провайдер -> Broker : record-deployment --environment [prod]
@enduml
```
</details>
