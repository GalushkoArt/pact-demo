# Документация по проекту Pact Contract Testing Demo

Этот проект демонстрирует контрактное тестирование на основе Pact в архитектуре микросервисов, фокусируясь на домене сервиса цен с REST API коммуникацией между провайдером и потребителем.

## Обзор проекта

Проект состоит из следующих модулей:

- **price-service-api**: Общие определения API (DTO и интерфейсы)
- **price-service-provider**: Реализация провайдера на Spring Boot
- **price-service-consumer**: Реализация потребителя с контрактными тестами
- **pact-broker**: Настройка Docker Compose для Pact Broker

## Архитектура

Проект следует Гексагональной Архитектуре (Порты и Адаптеры) с четким разделением между:

- **Ядро домена**: Бизнес-логика в центре
- **Порты**: Интерфейсы, определяющие как ядро взаимодействует с внешними системами
- **Адаптеры**: Реализации, соединяющие с внешними системами

Эта архитектура обеспечивает:
- Четкое разделение бизнес-логики от внешних зависимостей
- Тестируемость логики ядра домена в изоляции
- Гибкость в изменении внешних зависимостей без влияния на ядро

## Предварительные требования

- Java 17 или выше
- Gradle 8.0 или выше
- Docker и Docker Compose (для запуска Pact Broker)

## Начало работы

### 1. Клонирование репозитория

```bash
git clone https://github.com/yourusername/pact-demo.git
cd pact-demo
```

### 2. Запуск Pact Broker

```bash
cd pact-broker
docker-compose up -d
```

Pact Broker будет доступен по адресу http://localhost:9292 со следующими учетными данными:
- Имя пользователя: `pact`
- Пароль: `pact`

### 3. Запуск тестов потребителя и публикация контрактов

```bash
./gradlew :price-service-consumer:clean :price-service-consumer:test :price-service-consumer:pactPublish
```

Это:
- Запустит тесты потребителя
- Сгенерирует файлы контрактов Pact
- Опубликует контракты в Pact Broker

### 4. Запуск провайдера и проверка контрактов

```bash
./gradlew :price-service-provider:clean :price-service-provider:test
```

Это:
- Запустит сервис провайдера
- Получит контракты из Pact Broker
- Проверит, что провайдер может выполнить контракты

### 5. Запуск полной сборки

```bash
./gradlew clean build
```

## Детали модулей

### price-service-api

Этот модуль содержит общие определения API:

- **DTO**: Объекты передачи данных для коммуникации между сервисами
- **Интерфейсы сервисов**: Контракты, определяющие операции сервиса

### price-service-provider

Провайдер реализует REST API для сервиса цен со следующими эндпоинтами:

- `GET /prices`: Получение всех цен
- `GET /prices/{instrumentId}`: Получение цены для конкретного инструмента
- `POST /prices/{instrumentId}`: Создание или обновление цены для конкретного инструмента
- `DELETE /prices/{instrumentId}`: Удаление цены для конкретного инструмента
- `GET /orderbook/{instrumentId}`: Получение книги заказов для конкретного инструмента

Провайдер включает:
- Документацию OpenAPI по адресу `/swagger-ui.html`
- In-memory репозиторий с примерами данных
- Гексагональную архитектуру с доменом, портами и адаптерами

### price-service-consumer

Потребитель реализует клиент для сервиса цен с:

- REST клиентом для коммуникации с провайдером
- Pact контрактными тестами, определяющими ожидаемое поведение
- Сервисным слоем для бизнес-логики

### pact-broker

Настройка Docker Compose для Pact Broker, включая:

- Сервис Pact Broker
- База данных PostgreSQL для хранения контрактов

## Рабочий процесс контрактного тестирования

1. **Потребитель определяет контракты**: Потребитель создает Pact контрактные тесты, которые определяют его ожидания от провайдера.

2. **Публикация контрактов**: Контракты публикуются в Pact Broker.

3. **Провайдер проверяет контракты**: Провайдер проверяет, что он может выполнить контракты.

4. **Интеграция CI/CD**: Рабочий процесс интегрируется в CI/CD пайплайны для обеспечения постоянной проверки контрактов.

## Когда использовать Pact по сравнению с другими видами тестирования

- **Модульные тесты**: Для тестирования бизнес-логики в изоляции
- **Pact тесты**: Для тестирования границ сервисов и API контрактов
- **Интеграционные тесты**: Для тестирования взаимодействия с базами данных и другими зависимостями
- **End-to-End тесты**: Для тестирования критических пользовательских сценариев

Pact особенно ценен, когда:
- У вас есть несколько сервисов, которым нужно взаимодействовать
- Вы хотите обнаруживать критические изменения до деплоя
- Вы хотите развивать свои API с уверенностью
- Вы хотите уменьшить необходимость в end-to-end тестировании

## Интеграция CI/CD

### Пример GitLab CI

Создайте файл `.gitlab-ci.yml` в корне вашего проекта:

```yaml
stages:
  - test
  - publish
  - verify

variables:
  PACT_BROKER_URL: "http://pact-broker:9292"
  PACT_BROKER_USERNAME: "pact"
  PACT_BROKER_PASSWORD: "pact"

services:
  - name: postgres:14
    alias: postgres
  - name: pactfoundation/pact-broker:2.107.0.1
    alias: pact-broker
    variables:
      PACT_BROKER_DATABASE_URL: "postgres://postgres:postgres@postgres/postgres"
      PACT_BROKER_BASIC_AUTH_USERNAME: "pact"
      PACT_BROKER_BASIC_AUTH_PASSWORD: "pact"
      PACT_BROKER_PORT: "9292"
      PACT_BROKER_ALLOW_PUBLIC_READ: "true"

consumer_test:
  stage: test
  script:
    - ./gradlew :price-service-consumer:clean :price-service-consumer:test

publish_pacts:
  stage: publish
  script:
    - ./gradlew :price-service-consumer:pactPublish
  dependencies:
    - consumer_test

provider_verify:
  stage: verify
  script:
    - ./gradlew :price-service-provider:clean :price-service-provider:test
  dependencies:
    - publish_pacts
```

## Преимущества контрактов, управляемых потребителем

1. **Четкое разделение ответственности**:
   - Ответственность провайдера и потребителя четко определены
   - API контракты явные и версионированные

2. **Эволюционный дизайн**:
   - Изменения в контрактах обнаруживаются рано
   - Критические изменения идентифицируются до деплоя

3. **Уверенность в деплоях**:
   - Проверенные контракты обеспечивают совместимость
   - Снижен риск проблем интеграции

4. **Документация как побочный продукт**:
   - Контракты служат живой документацией
   - Интеграция OpenAPI предоставляет дополнительную документацию API

## Устранение неполадок

### Проблемы подключения к Pact Broker

Если у вас возникли проблемы с подключением к Pact Broker:

1. Убедитесь, что контейнеры Docker запущены:
   ```bash
   docker-compose -f pact-broker/docker-compose.yml ps
   ```

2. Проверьте логи:
   ```bash
   docker-compose -f pact-broker/docker-compose.yml logs
   ```

3. Проверьте доступность брокера:
   ```bash
   curl -u pact:pact http://localhost:9292
   ```

### Ошибки проверки контрактов

Если проверка контрактов не удалась:

1. Проверьте логи провайдера для детальных сообщений об ошибках
2. Убедитесь, что настройка состояния провайдера корректна
3. Обновите тесты потребителя или реализацию провайдера по необходимости

## Заключение

Этот проект демонстрирует, как реализовать контрактное тестирование, управляемое потребителем, с использованием Pact в среде Java микросервисов. Следуя шаблонам и практикам, показанным здесь, вы можете создавать более надежные и поддерживаемые интеграции сервисов.
